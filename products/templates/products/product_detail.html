{% extends 'base.html' %}

{% block title %}{{ product.name }} - E-commerce Store{% endblock %}

{% block content %}
<div class="row">
    <!-- Product Details -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <!-- Breadcrumb Navigation -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'products:product_list' %}">All Products</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'products:product_list_by_category' category=product.category %}">
                                {{ product.category }}
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                    </ol>
                </nav>

                <div class="row">
                    <!-- Product Image -->
                    <div class="col-md-6">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" 
                                 class="img-fluid rounded" 
                                 alt="{{ product.name }}"
                                 style="width: 100%; max-height: 400px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                 style="height: 400px;">
                                <span class="text-muted fs-4">No Image Available</span>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Product Information -->
                    <div class="col-md-6">
                        <!-- Category Badge -->
                        <span class="badge bg-secondary mb-3">{{ product.category }}</span>
                        
                        <!-- Product Name -->
                        <h1 class="h2 mb-3">{{ product.name }}</h1>
                        
                        <!-- Price -->
                        <h3 class="text-primary mb-4">${{ product.price }}</h3>
                        
                        <!-- Product Description -->
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p class="text-muted">{{ product.description }}</p>
                        </div>
                        
                        <!-- Product Meta Information -->
                        <div class="mb-4">
                            <small class="text-muted">
                                <strong>Added:</strong> {{ product.created_at|date:"F d, Y" }}<br>
                                {% if product.updated_at != product.created_at %}
                                    <strong>Updated:</strong> {{ product.updated_at|date:"F d, Y" }}
                                {% endif %}
                            </small>
                        </div>
                        
                        <!-- Action Buttons -->
                        {% if user.is_authenticated %}
                            <form method="post" action="{% url 'products:add_to_cart' product.id %}" class="mb-3">
                                {% csrf_token %}
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <label for="quantity" class="form-label">Quantity:</label>
                                        <input type="number" 
                                               id="quantity" 
                                               name="quantity" 
                                               value="1" 
                                               min="1" 
                                               max="99" 
                                               class="form-control">
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-shopping-cart"></i> Add to Cart
                                    </button>
                                    <input type="hidden" name="next" value="product">
                                </div>
                            </form>
                            
                            <!-- Simplified Like/Dislike Buttons -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <button id="like-btn" class="btn btn-outline-success w-100">
                                        <i class="fas fa-thumbs-up"></i> 
                                        <span id="like-text">Like</span>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button id="dislike-btn" class="btn btn-outline-danger w-100">
                                        <i class="fas fa-thumbs-down"></i> 
                                        <span id="dislike-text">Dislike</span>
                                    </button>
                                </div>
                            </div>
                            
                            
                        {% else %}
                            <div class="alert alert-info">
                                <a href="/admin/login/" class="btn btn-primary">Login</a> to add items to cart
                            </div>
                        {% endif %}
                        
                        <!-- User Interaction Info (for authenticated users) -->
                        {% if user.is_authenticated and user_interactions %}
                            <div class="mt-4">
                                <small class="text-muted">
                                    <strong>Your interactions:</strong>
                                    {% for interaction in user_interactions %}
                                        <span class="badge bg-info me-1">{{ interaction.get_interaction_type_display }}</span>
                                    {% endfor %}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar with Related Products -->
    <div class="col-lg-4">
        <!-- Related Products -->
        {% if related_products %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Related Products</h5>
                    <small class="text-muted">More from {{ product.category }}</small>
                </div>
                <div class="card-body">
                    {% for related_product in related_products %}
                        <div class="d-flex mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                            <!-- Related Product Image -->
                            <div class="flex-shrink-0 me-3">
                                {% if related_product.image %}
                                    <img src="{{ related_product.image.url }}" 
                                         class="rounded" 
                                         alt="{{ related_product.name }}"
                                         style="width: 60px; height: 60px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="width: 60px; height: 60px;">
                                        <small class="text-muted">No img</small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Related Product Info -->
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <a href="{% url 'products:product_detail' pk=related_product.pk %}" 
                                       class="text-decoration-none">
                                        {{ related_product.name }}
                                    </a>
                                </h6>
                                <p class="text-muted small mb-1">
                                    {% if related_product.description|length > 50 %}
                                        {{ related_product.description|slice:":50" }}...
                                    {% else %}
                                        {{ related_product.description }}
                                    {% endif %}
                                </p>
                                <strong class="text-primary">${{ related_product.price }}</strong>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- View More Link -->
                    <div class="text-center mt-3">
                        <a href="{% url 'products:product_list_by_category' category=product.category %}" 
                           class="btn btn-outline-primary btn-sm">
                            View All {{ product.category }} Products
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Simplified Recommendations -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-robot"></i> Recommendations
                </h5>
                <button id="refresh-recommendations" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <!-- Simple loading indicator -->
                <div id="recommendations-loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <p class="mt-2 mb-0 text-muted">Loading...</p>
                </div>
                
                <!-- Recommendations container -->
                <div id="recommendations-container" style="display: none;">
                    <!-- Recommendations loaded via AJAX -->
                </div>
                
                <!-- Simple error message -->
                <div id="recommendations-error" class="alert alert-warning" style="display: none;">
                    Unable to load recommendations.
                    <button id="retry-recommendations" class="btn btn-sm btn-outline-warning ms-2">
                        Retry
                    </button>
                </div>
                
                <!-- Simple no recommendations message -->
                <div id="no-recommendations" class="text-center py-3" style="display: none;">
                    <p class="text-muted mb-0">No recommendations available.</p>
                </div>
            </div>
        </div>

        <!-- Back to Products -->
        <div class="card mt-3">
            <div class="card-body text-center">
                <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                    ← Back to All Products
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Additional Product Information (if needed) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Product Details</h6>
                        <ul class="list-unstyled">
                            <li><strong>Category:</strong> {{ product.category }}</li>
                            <li><strong>Price:</strong> ${{ product.price }}</li>
                            <li><strong>Added:</strong> {{ product.created_at|date:"F d, Y" }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Description</h6>
                        <p class="text-muted">{{ product.description }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simplified JavaScript for beginner-level implementation
    const productId = {{ product.id }};
    
    // Initialize like/dislike buttons
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    
    // Add event listeners for like/dislike buttons
    if (likeBtn) {
        likeBtn.addEventListener('click', () => handleInteraction('like'));
    }
    if (dislikeBtn) {
        dislikeBtn.addEventListener('click', () => handleInteraction('dislike'));
    }
    
    // Load recommendations on page load
    loadRecommendations();
    
    function handleInteraction(interactionType) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Disable buttons during request
        likeBtn.disabled = true;
        dislikeBtn.disabled = true;
        
        fetch(`/product/${productId}/interact/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({'interaction_type': interactionType})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button states
                updateButtonState(interactionType, data.is_active);
                updateButtonState(interactionType === 'like' ? 'dislike' : 'like', false);
                
                // Show simple message
                showMessage(data.message, 'success');
                
                // Refresh recommendations
                setTimeout(() => loadRecommendations(), 500);
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Network error occurred', 'error');
        })
        .finally(() => {
            // Re-enable buttons
            likeBtn.disabled = false;
            dislikeBtn.disabled = false;
        });
    }
    
    function updateButtonState(interactionType, isActive) {
        const btn = document.getElementById(`${interactionType}-btn`);
        const text = document.getElementById(`${interactionType}-text`);
        
        if (isActive) {
            btn.className = `btn btn-${interactionType === 'like' ? 'success' : 'danger'} w-100`;
            text.textContent = interactionType === 'like' ? 'Liked' : 'Disliked';
        } else {
            btn.className = `btn btn-outline-${interactionType === 'like' ? 'success' : 'danger'} w-100`;
            text.textContent = interactionType === 'like' ? 'Like' : 'Dislike';
        }
    }
    
    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show mt-3" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const productDetails = document.querySelector('.col-lg-8 .card-body');
        productDetails.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            const alert = productDetails.querySelector('.alert');
            if (alert) alert.remove();
        }, 3000);
    }
    
    function loadRecommendations() {
        const container = document.getElementById('recommendations-container');
        const loading = document.getElementById('recommendations-loading');
        const error = document.getElementById('recommendations-error');
        const noRecs = document.getElementById('no-recommendations');
        
        // Show loading
        loading.style.display = 'block';
        container.style.display = 'none';
        error.style.display = 'none';
        noRecs.style.display = 'none';
        
        fetch(`/recommendations/api/recommendations/${productId}/?num_recommendations=4`)
            .then(response => response.json())
            .then(data => {
                if (data.recommendations && data.recommendations.length > 0) {
                    displayRecommendations(data.recommendations);
                    container.style.display = 'block';
                } else {
                    noRecs.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendations-error').style.display = 'block';
            })
            .finally(() => {
                loading.style.display = 'none';
            });
    }
    
    function displayRecommendations(recommendations) {
        const container = document.getElementById('recommendations-container');
        
        let html = '';
        recommendations.forEach((rec, index) => {
            const imageHtml = rec.image_url 
                ? `<img src="${rec.image_url}" class="rounded" alt="${rec.name}" style="width: 60px; height: 60px; object-fit: cover;">`
                : `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                     <small class="text-muted">No img</small>
                   </div>`;
            
            html += `
                <div class="d-flex mb-3 ${index < recommendations.length - 1 ? 'border-bottom pb-3' : ''}">
                    <div class="flex-shrink-0 me-3">${imageHtml}</div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="${rec.detail_url}" class="text-decoration-none">
                                ${rec.name}
                            </a>
                        </h6>
                        <p class="text-muted small mb-1">
                            <span class="badge bg-light text-dark me-1">${rec.category}</span>
                            ${rec.reason}
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="text-primary">$${rec.price}</strong>
                            <div>
                                <button type="button" class="btn btn-outline-success btn-sm me-1" 
                                        onclick="handleRecommendationFeedback(${rec.product_id}, 'like', this)">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="handleRecommendationFeedback(${rec.product_id}, 'dislike', this)">
                                    <i class="fas fa-thumbs-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Simple recommendation feedback function
    window.handleRecommendationFeedback = function(productId, interactionType, buttonEl) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        buttonEl.disabled = true;
        
        fetch(`/product/${productId}/interact/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({'interaction_type': interactionType})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button appearance
                if (data.is_active) {
                    buttonEl.className = `btn btn-${interactionType === 'like' ? 'success' : 'danger'} btn-sm me-1`;
                } else {
                    buttonEl.className = `btn btn-outline-${interactionType === 'like' ? 'success' : 'danger'} btn-sm me-1`;
                }
                
                // Reset opposite button
                const oppositeType = interactionType === 'like' ? 'dislike' : 'like';
                const oppositeBtn = buttonEl.parentElement.querySelector(`.btn-${oppositeType}, .btn-outline-${oppositeType}`);
                if (oppositeBtn) {
                    oppositeBtn.className = `btn btn-outline-${oppositeType === 'like' ? 'success' : 'danger'} btn-sm`;
                }
            }
        })
        .finally(() => {
            buttonEl.disabled = false;
        });
    };
    
    // Add refresh button functionality
    const refreshBtn = document.getElementById('refresh-recommendations');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadRecommendations);
    }
    
    const retryBtn = document.getElementById('retry-recommendations');
    if (retryBtn) {
        retryBtn.addEventListener('click', loadRecommendations);
    }
});
</script>
{% endblock %}